"use client"

import { useEffect, useRef, useState } from "react"
import Script from "next/script"

interface Experience {
  experience: string
  dimension: string
  research: number
  pm: number
  bubble: number
  description: string
  dateRange: string
  keySkills: string[]
  isTemporary?: boolean
}

export default function Resume() {
  const plotRef = useRef<HTMLDivElement>(null)
  const [selectedPointIndex, setSelectedPointIndex] = useState<number | null>(null)
  const [selectedExperience, setSelectedExperience] = useState<Experience | null>(null)
  const [plotlyLoaded, setPlotlyLoaded] = useState(false)

  const experiences: Experience[] = [
    {
      experience: "Research Coordinator",
      dimension: "Work Experience",
      research: 6,
      pm: 9,
      bubble: 3,
      description: "Assisted in behavioral tasks & MRI setup for toddlers",
      dateRange: "June 2023 - Present",
      keySkills: ["Project Management", "MRI Operations", "Child Psychology", "Data Collection", "Team Leadership"],
    },
    {
      experience: "Teaching Assistant",
      dimension: "Work Experience",
      research: 3,
      pm: 2.2,
      bubble: 3,
      description: "Led end-to-end development of wearable + API integration",
      dateRange: "September 2022 - May 2023",
      keySkills: ["Teaching", "Curriculum Development", "Student Mentoring", "Academic Support"],
    },
    {
      experience: "MRI Research Assistant",
      dimension: "Internship",
      research: 8,
      pm: 3,
      bubble: 3,
      description: "Designed and analyzed visual attention EEG study",
      dateRange: "May 2022 - August 2022",
      keySkills: ["MRI Technology", "EEG Analysis", "Visual Attention Research", "Data Analysis", "MATLAB"],
    },
    {
      experience: "Bioelectronics Research Volunteer",
      dimension: "Activities",
      research: 9,
      pm: 2,
      bubble: 3,
      description: "Analyzed patient data for tumor DNA structure and behavior",
      dateRange: "January 2022 - December 2022",
      keySkills: ["Bioelectronics", "DNA Analysis", "Patient Data", "Research Methods", "Laboratory Techniques"],
    },
    {
      experience: "Director of Events Planning",
      dimension: "Work Experience",
      research: 0,
      pm: 10,
      bubble: 3,
      description: "Designed social connectedness experiment, ran EMG recordings",
      dateRange: "August 2021 - May 2022",
      keySkills: [
        "Event Planning",
        "Budget Management",
        "Team Coordination",
        "Vendor Relations",
        "Timeline Management",
      ],
    },
    {
      experience: "Japanese Club President",
      dimension: "Activities",
      research: 1,
      pm: 9,
      bubble: 3,
      description: "Organized presentation for interdisciplinary audience",
      dateRange: "September 2020 - May 2021",
      keySkills: [
        "Leadership",
        "Cultural Programming",
        "Public Speaking",
        "Event Organization",
        "Cross-cultural Communication",
      ],
    },
    {
      experience: "Physical Therapy Aide",
      dimension: "Work Experience",
      research: 1,
      pm: 1.5,
      bubble: 3,
      description: "Led recruitment & protocol for 3 AI + health studies",
      dateRange: "June 2020 - August 2021",
      keySkills: [
        "Patient Care",
        "Physical Rehabilitation",
        "Medical Equipment",
        "Patient Communication",
        "Healthcare Support",
      ],
    },
  ]

  const colorMap = {
    Activities: "#3da4ab",
    "Work Experience": "#f6cd61",
    Internship: "#fe8a71",
  }

  useEffect(() => {
    if (plotlyLoaded && plotRef.current && typeof window !== "undefined" && (window as any).Plotly) {
      renderPlot()
      setupEventListeners()
    }
  }, [plotlyLoaded, selectedPointIndex])

  const setupEventListeners = () => {
    if (!plotRef.current || !(window as any).Plotly) return

    // Remove existing event listeners to prevent duplicates
    plotRef.current.removeAllListeners?.("plotly_hover")
    plotRef.current.removeAllListeners?.("plotly_unhover")
    plotRef.current.removeAllListeners?.("plotly_click")

    // Hover events - only work when no point is permanently selected
    plotRef.current.on("plotly_hover", (data: any) => {
      if (!selectedExperience) {
        const point = data.points[0].customdata
        setSelectedPointIndex(point.index)
        // Create temporary experience object for hover preview
        const tempExperience = experiences.find((exp) => exp.experience === point.experience)
        if (tempExperience) {
          setSelectedExperience({ ...tempExperience, isTemporary: true })
        }
      }
    })

    plotRef.current.on("plotly_unhover", () => {
      // Only clear if it's a temporary hover selection
      if (selectedExperience?.isTemporary) {
        setSelectedPointIndex(null)
        setSelectedExperience(null)
      }
    })

    // Click events - permanently select a point
    plotRef.current.on("plotly_click", (data: any) => {
      const point = data.points[0].customdata
      const clickedExperience = experiences.find((exp) => exp.experience === point.experience)

      if (clickedExperience) {
        // If clicking the same point that's already selected, deselect it
        if (
          selectedExperience &&
          !selectedExperience.isTemporary &&
          selectedExperience.experience === clickedExperience.experience
        ) {
          setSelectedPointIndex(null)
          setSelectedExperience(null)
        } else {
          // Select the new point permanently
          setSelectedPointIndex(point.index)
          setSelectedExperience({ ...clickedExperience, isTemporary: false })
        }
      }
    })
  }

  const renderPlot = () => {
    if (!plotRef.current || !(window as any).Plotly) return

    const trace = {
      x: experiences.map((d) => d.pm),
      y: experiences.map((d) => d.research),
      text: experiences.map((d) => d.experience),
      customdata: experiences.map((d, i) => ({ ...d, index: i })),
      mode: "markers",
      type: "scatter",
      marker: {
        size: experiences.map((d) => d.bubble * 10),
        color: experiences.map((d) => colorMap[d.dimension as keyof typeof colorMap]),
        line: {
          width: experiences.map((_, i) => (i === selectedPointIndex ? 3 : 0)),
          color: experiences.map(() => "black"),
        },
      },
      hovertemplate: "%{text}<extra></extra>",
    }

    const layout = {
      xaxis: {
        title: "Project Management Rating",
        range: [0, 10],
        fixedrange: true,
        showspikes: false,
        showline: true,
        showticklabels: true,
      },
      yaxis: {
        title: "Research Rating",
        range: [0, 10],
        fixedrange: true,
      },
      margin: { l: 60, r: 60, t: 60, b: 60 },
      showlegend: false,
      hovermode: "closest",
      responsive: true,
      autosize: true,
    }

    const config = {
      displayModeBar: false,
      responsive: true,
    }
    ;(window as any).Plotly.react(plotRef.current, [trace], layout, config)
  }

  const handleOutsideClick = () => {
    // Only clear permanently selected points, not temporary hover selections
    if (selectedExperience && !selectedExperience.isTemporary) {
      setSelectedExperience(null)
      setSelectedPointIndex(null)
    }
  }

  return (
    <>
      <Script src="https://cdn.plot.ly/plotly-latest.min.js" onLoad={() => setPlotlyLoaded(true)} />

      <div className="min-h-screen bg-white text-gray-900 font-sans leading-relaxed overflow-x-hidden">
        <div className="max-w-full mx-auto px-6 py-12 min-h-screen">
          {/* Updated grid with less white space on right */}
          <div className="grid grid-cols-1 lg:grid-cols-[2fr_auto] gap-8 max-w-full">
            <div className="flex flex-col gap-6 min-w-0 overflow-hidden">
              <a
                href="/"
                className="text-2xl font-bold text-gray-900 hover:text-gray-600 transition-colors flex-shrink-0"
              >
                Philo Katzman
              </a>

              <div className="flex flex-col gap-6 mt-8 relative min-w-0 max-w-full">
                <p className="max-w-full break-words">
                  I am a recent graduate with a background in computational neuroscience, cognitive science, and
                  biomedical signal processing. My work bridges technical development and human-centered research,
                  focusing on wearable technologies, experimental design, and data-driven health tools.
                </p>

                <div className="flex gap-8 justify-start text-sm flex-wrap">
                  <p className="m-0 whitespace-nowrap">
                    <span className="text-[#3da4ab] font-bold">●</span> Activities
                  </p>
                  <p className="m-0 whitespace-nowrap">
                    <span className="text-[#f6cd61] font-bold">●</span> Work Experience
                  </p>
                  <p className="m-0 whitespace-nowrap">
                    <span className="text-[#fe8a71] font-bold">●</span> Internship
                  </p>
                </div>

                <div ref={plotRef} className="w-full h-auto min-h-[300px] max-w-full overflow-hidden" />

                <div
                  className="bg-gray-50 rounded-lg p-6 w-full min-h-[120px] border border-gray-200"
                  onClick={(e) => e.stopPropagation()}
                >
                  {selectedExperience ? (
                    <div className="flex flex-col gap-4">
                      <div className="flex items-center justify-between">
                        <div className="text-xl font-bold text-gray-900">Experience Details</div>
                        {selectedExperience.isTemporary ? (
                          <div className="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">
                            Hover Preview - Click to Select
                          </div>
                        ) : (
                          <div className="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded">
                            Selected - Click outside to deselect
                          </div>
                        )}
                      </div>
                      <div className="flex flex-col gap-4">
                        <div className="text-lg font-semibold text-gray-900">{selectedExperience.experience}</div>
                        <div className="text-sm text-gray-600 italic">{selectedExperience.dateRange}</div>
                        <div className="text-base text-gray-700 leading-6">{selectedExperience.description}</div>

                        <div className="flex flex-col gap-3 my-2">
                          <div className="flex flex-col gap-1">
                            <div className="flex justify-between items-center text-sm font-semibold text-gray-900">
                              Research Experience
                              <span className="text-xs text-gray-600 font-normal">
                                {selectedExperience.research}/10
                              </span>
                            </div>
                            <div className="w-full h-2 bg-gray-200 rounded overflow-hidden">
                              <div
                                className="h-full bg-blue-500 rounded transition-all duration-300"
                                style={{ width: `${(selectedExperience.research / 10) * 100}%` }}
                              />
                            </div>
                          </div>
                          <div className="flex flex-col gap-1">
                            <div className="flex justify-between items-center text-sm font-semibold text-gray-900">
                              Project Management
                              <span className="text-xs text-gray-600 font-normal">{selectedExperience.pm}/10</span>
                            </div>
                            <div className="w-full h-2 bg-gray-200 rounded overflow-hidden">
                              <div
                                className="h-full bg-green-500 rounded transition-all duration-300"
                                style={{ width: `${(selectedExperience.pm / 10) * 100}%` }}
                              />
                            </div>
                          </div>
                        </div>

                        <div className="mt-2">
                          <div className="text-sm font-semibold text-gray-900 mb-2">Key Skills:</div>
                          <div className="flex flex-wrap gap-2">
                            {selectedExperience.keySkills.map((skill, index) => (
                              <span
                                key={index}
                                className="bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap"
                              >
                                {skill}
                              </span>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <>
                      <div className="text-xl font-bold text-gray-900 mb-2">Select an Experience</div>
                      <div className="text-sm text-gray-600">
                        Click on a point to see detailed information about that experience
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>

            {/* Reduced sidebar width and padding */}
            <nav className="flex flex-col gap-4 pt-16 min-w-0 w-48">
              <a href="/projects" className="text-lg text-gray-900 hover:text-gray-600 transition-colors break-words">
                Projects
              </a>
              <a
                href="/resume"
                className="text-lg text-gray-900 hover:text-gray-600 transition-colors font-semibold break-words"
              >
                Resume
              </a>
              <a
                href="/tangents"
                className="text-lg text-gray-900 hover:text-gray-600 transition-colors break-words leading-5"
              >
                Tangents and 'Ted Talks'
              </a>
              <a href="/about" className="text-lg text-gray-900 hover:text-gray-600 transition-colors break-words">
                About Me
              </a>
              <a href="/linkedin" className="text-lg text-gray-900 hover:text-gray-600 transition-colors break-words">
                LinkedIn
              </a>
              <a href="/more" className="text-lg text-gray-900 hover:text-gray-600 transition-colors break-words">
                More
              </a>
            </nav>
          </div>
        </div>

        {/* Click outside to deselect */}
        <div className="fixed inset-0 -z-10" onClick={handleOutsideClick} />
      </div>
    </>
  )
}
